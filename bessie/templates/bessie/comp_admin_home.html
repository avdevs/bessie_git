{% extends 'bessie/dashboard.html' %}
{% block content %}
<!-- Metrics Section -->
<div class="section">
  <h2 class="section-title">Company Metrics</h2>
  <div class="metrics-grid">
    <!-- TODO: These metrics doesn't seem to be working correctly hidden away for now
     NO BACKEND FUNCTIONALITY has been altered, when working with this, check backend -->
    <!-- <div class="metric-card">
      <div class="metric-title">Slots Available</div>
      <div class="metric-value">{{ available_slots }}</div>
    </div>
    <div class="metric-card">
      <div class="metric-title">Slots Used</div>
      <div class="metric-value">{{ company.used_slots }}</div>
    </div> -->
    <div class="metric-card">
      <div class="metric-title">Surveys Taken</div>
      <div class="metric-value">{{ quizzes }}</div>
    </div>
  </div>
</div>

<!-- TODO: Hiding this for now, enable back on when Nicky is confident that Admins can upload employee data themselves.
 This is enabled for super admins and some backend changes needed to be made to allow this:
 - For regular admins, the company was obtained from CompanyAdmin model, where as for super admin the company has to be passed
 in in the request therefore:
 - users/urls.py commented out original path and added new one where we pass the company id
 - users/views.py commented out original way to obtain company object and added getting company by id
-->
<!-- <div class="section">
  <h2 class="section-title">Invite Employees</h2>
  <p>Download the csv file sample below, enter employee details and reupload it.</p>
  <p>employees will automatically be sent an ivite email with a login password</p>
  <a href="{% url 'csv_sample' %}">Click here to download csv file sample</a>
  <br>
  <h4>Upload filled csv file below</h4>
  <form method="post" action="{% url 'upload_csv' %}" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-group">
      {{ form.csv_file.label_tag }}
      {{ form.csv_file }}

      {% if form.csv_file.errors %}
      <div class="alert alert-danger">
        {% for error in form.csv_file.errors %}
        {{ error }}
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <button type="submit" class="btn btn-primary">Upload CSV</button>
  </form>
</div> -->


<div class="section">
  <h2 class="section-title">Company results</h2>
  {% if company.results_visible %}
  {% if results_ready %}
  <div>
    <a href="{% url 'company_results' company.id %}">View results</a>
    {% for team in company.teams %}
    <a href="{% url 'company_results' company.id %}?team={{team}}">{{ team }}</a>
    {% endfor %}
  </div>
  {% if company.results_video %}
  <video width="854" height="480" controls>
    <source src="{{ company.results_video.url }}" type="video/mp4">
  </video>
  {% endif %}
  {% else %}
  <p>Cummulative results not ready. Some employees have not submitted their responses</p>
  {% endif %}
  {% else %}
  <p>Your results are not ready yet. You will be notified when you can view the results.</p>
  {% endif %}

</div>

<!-- TODO: This is hidden away as currently admins should not be able to see individual employees.
  NO BACKEND FUNCTIONALITY HAS BEEN ALTERED, so when decided that this is permanently hidden, the backend
  functionality can be removed
-->
<!-- Employees Section -->
<!-- <div class="section">
  <div style="display: flex; width: 100%; justify-content: space-between;">
    <h2 class="section-title">Company Employees</h2>
    <a href="{% url 'user_list' 0 %}">See All</a>
  </div>
  <table>
    <thead>
      <tr>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
        {% if request.user.is_staff %}
        <th>Quiz Status</th>
        <th>Export Data</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for item in employees %}
      <tr>
        <td>{{ item.user.first_name }}</td>
        <td>{{ item.user.last_name }}</td>
        <td>{{ item.user.email }}</td>
        {% if request.user.is_staff %}
        {% if item.has_response > 0 %}
        <td><span class="badge badge-success">Completed</span></td>
        {% else %}
        <td><span class="badge badge-warning">Pending</span></td>
        {% endif %}
        {% if item.has_response > 0 %}
        <td><a href="{% url 'export_data' item.id %}" style="margin-bottom: 0;">Export Data</a></td>
        {% endif %}
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div> -->

<!-- Admins Section -->
<div class="section">
  <div style="display: flex; width: 100%; justify-content: space-between;">
    <h2 class="section-title">Company Admins</h2>
    <!-- TODO: This is hidden away as admins should not be able to add other admins
      NO BACKEND FUNCTIONALITY HAS BEEN ALTERED, so when decided that this is permanently hidden, the backend
      functionality can be removed 
    -->
    <!-- {% if company_admins|length < 3 %} <button id="addAdmin" class="btn btn-primary">Add User</button>
      {% else %}
      <span>Admin limit reached</span>
      {% endif %} -->
  </div>
  <div id="adminForm" class="hide">
    <form method="POST" action="{% url 'invite_admin' %}">
      {% csrf_token %}
      {{ form1.company_id }}
      <div class="form-section">
        <h2 class="section-title">Admin Details</h2>

        <div class="form-group">
          {{ form1.first_name.errors }}
          <label for="firstName">First Name<span class="required">*</span></label>
          {{ form1.first_name }}
        </div>

        <div class="form-group">
          {{ form1.last_name.errors }}
          <label for="lastName">Last Name<span class="required">*</span></label>
          {{ form1.last_name }}
        </div>

        <div class="form-group">
          {{ form1.email.errors }}
          <label for="email">Email Address<span class="required">*</span></label>
          {{ form1.email }}
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </div>
  <table>
    <thead>
      <tr>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody>
      {% for item in company_admins %}
      <tr>
        <td>{{ item.user.first_name }}</td>
        <td>{{ item.user.last_name }}</td>
        <td>{{ item.user.email }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  console.log("running")
  const adminForm = document.getElementById("adminForm")
  const addAdmin = document.getElementById("addAdmin")
  addAdmin.addEventListener('click', (e) => {
    if (!adminForm.classList.contains("hide")) {
      adminForm.classList.add("hide")
      addAdmin.innerText = "Add User"
    } else {
      adminForm.classList.remove("hide")
      addAdmin.innerText = "Close"
    }
  })
</script>
{% endblock %}